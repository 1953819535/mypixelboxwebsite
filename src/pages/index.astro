---
import axios from "axios";

// ----------------------------------------------------------------------
// 1. 工具函数
// ----------------------------------------------------------------------
function getImg(path: string, w: number = 0, q: number = 80) {
  if (!path) return "";
  if (path.startsWith("http")) return path;
  const cleanPath = path.replace(/^\//, "");
  // 使用环境变量配置的图片服务器域名
  const imageUrl = import.meta.env.IMAGE_URL;
  if (!imageUrl) return ""; 
  if (!w) return `${imageUrl}/${cleanPath}`;
  return `${imageUrl}/cdn-cgi/image/width=${w},quality=${q},format=auto/${cleanPath}`;
}

// ----------------------------------------------------------------------
// 2. 类型定义
// ----------------------------------------------------------------------
interface Photo {
  _id: string;
  albumId: string;
  fileID: string;
  description: string;
  order: number;
  width: number;
  height: number;
  isFeatured: boolean;
  createTime?: string;
  _openid?: string;
  updatedAt?: string;
  __v?: number;
  userId?: string;
  createdAt?: string;
}

interface Album {
  id: string;
  photos: Photo[];
  name: string;
  description: string;
  coverPhotoUrl: string;
  order: number;
  createTime: string;
  _openid?: string;
  likes?: string[];
  __v?: number;
  updatedAt?: string;
}

// ----------------------------------------------------------------------
// 3. 数据获取
// ----------------------------------------------------------------------
async function fetchAlbums(): Promise<Album[]> {
  try {
    const API_BASE_URL = import.meta.env.API_BASE_URL;

    if (!API_BASE_URL) {
      console.warn("未配置 API_BASE_URL 环境变量");
      return [];
    }

    console.log("获取数据开始", `${API_BASE_URL}/api/albums/gallery/public`);

    const response = await axios.get(
      `${API_BASE_URL}/api/albums/gallery/public`
    );
    const apiData = response.data;

    if (apiData.code !== 0) {
      throw new Error(apiData.message || "API请求失败");
    }

    console.log("获取数据成功");

    const albums: Album[] = apiData.data.map((album: any) => ({
      ...album,
      photos: album.photos.map((photo: any) => ({
        ...photo,
      })),
    }));

    return albums;
  } catch (err: any) {
    console.error("获取相册数据失败:", err.message, JSON.stringify(err));
    return [];
  }
}

// 服务端执行获取
const albums: Album[] = await fetchAlbums();

// 页面配置
const pageTitle = "WANDER | Some Portfolio";
const isTestMode = import.meta.env.TEST_MODE === "true";
---

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    {isTestMode && <meta name="test-mode" content="enabled" />}
  </head>
  <body>
    <!-- ==================== 导航系统 ==================== -->
    
    <!-- 1. 汉堡按钮 (固定在右上角) -->
    <button id="menu-btn" class="nav-btn">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        ><line x1="3" y1="12" x2="21" y2="12"></line><line
          x1="3"
          y1="6"
          x2="21"
          y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg
      >
    </button>

    <!-- 2. 全屏菜单 (Overlay) -->
    <div id="menu-overlay" class="menu-overlay">
      
      <!-- A. 滚动区域：包含菜单列表 -->
      <div class="menu-scroll-wrapper">
        <div class="menu-content">
          <p class="menu-label">INDEX</p>
          <ul class="menu-list">
            <li>
              <button data-goto="intro" class="menu-link">Home</button>
            </li>
            {
              albums.map((album, index) => (
                <li>
                  <button data-goto={`album-${album.id}`} class="menu-link">
                    {album.name} <span class="menu-num">0{index + 1}</span>
                  </button>
                </li>
              ))
            }
          </ul>
        </div>
      </div>

      <!-- B. 关闭按钮：独立于滚动区域，固定在底部 -->
      <button id="close-menu" class="close-btn-fixed">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><circle cx="12" cy="12" r="10"></circle><line
            x1="15"
            y1="9"
            x2="9"
            y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg
        >
      </button>

    </div>

    <!-- ==================== 主内容滚动区 ==================== -->
    <main class="snap-container">
      
      <!-- 1. Intro Section -->
      <section id="intro" class="snap-section intro-section">
        <div class="intro-content">
          <h1>WANDER</h1>
          <p>Some Photography Log</p>
          {
            isTestMode && (
              <div style="margin-top: 20px; padding: 10px; background: #ffeb3b; color: #000; border-radius: 4px;">
                <strong>测试模式已启用</strong>
              </div>
            )
          }
        </div>
        <div class="scroll-indicator">
          <svg
            width="24"
            height="24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"></path></svg
          >
        </div>
      </section>

      <!-- 2. Albums Loop -->
      {
        albums.map((album, index) => (
          <>
            {/* 章节封面 (图文分离布局) */}
            {album.coverPhotoUrl && (
              <section
                id={`album-${album.id}`}
                class="snap-section cover-layout"
              >
                <div class="cover-image-area">
                  <img
                    src={getImg(album.coverPhotoUrl, 1600)}
                    alt={`Cover of ${album.name}`}
                    loading="lazy"
                  />
                </div>
                
                <div class="cover-info-area">
                  <div class="cover-info-inner">
                    <span class="chapter-label">Chapter 0{index + 1}</span>
                    <h2 class="chapter-title">{album.name}</h2>
                    <div class="chapter-divider"></div>
                    {album.description && (
                      <p class="chapter-desc">{album.description}</p>
                    )}
                  </div>
                </div>
              </section>
            )}

            {/* 照片详情页 */}
            {album.photos.map((photo) => {
              const isPortrait = photo.height > photo.width;
              const photoSrc = getImg(photo.fileID, 1600);

              return (
                <section
                  class={`snap-section photo-layout ${isPortrait ? "layout-portrait" : "layout-landscape"}`}
                >
                  <div class="image-area">
                    <img
                      src={photoSrc}
                      loading="lazy"
                      alt={photo.description || album.name}
                    />
                  </div>
                  <div class="text-area">
                    <div class="text-inner">
                      <div class="text-header">
                        <span class="album-name">{album.name}</span>
                        <span class="photo-meta">
                          {photo.width} × {photo.height}
                        </span>
                      </div>
                      {photo.description && (
                        <p class="photo-desc">{photo.description}</p>
                      )}
                    </div>
                  </div>
                </section>
              );
            })}
          </>
        ))
      }

      <section class="snap-section footer-section">
        <p>The End</p>
      </section>
    </main>

    <script>
      const menuBtn = document.getElementById("menu-btn");
      const overlay = document.getElementById("menu-overlay");
      const closeMenuBtn = document.getElementById("close-menu");
      const menuLinks = document.querySelectorAll(".menu-link");

      function toggleMenu() {
        if (!overlay) return;
        overlay.classList.toggle("active");
      }

      menuBtn?.addEventListener("click", toggleMenu);
      closeMenuBtn?.addEventListener("click", toggleMenu);

      menuLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          // @ts-ignore
          const targetId = e.currentTarget.dataset.goto;
          const targetElement = document.getElementById(targetId);

          if (targetElement) {
            overlay?.classList.remove("active");
            targetElement.scrollIntoView({ behavior: "smooth" });
          }
        });
      });
    </script>

    <style>
      /* ================= 全局配置 ================= */
      :root {
        --bg-color: #050505;
        --text-main: #e4e4e7;
        --text-sub: #71717a;
        --accent: #f97316;
        --panel-bg: rgba(5, 5, 5, 0.95);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-main);
        font-family: system-ui, -apple-system, sans-serif;
        overflow: hidden; /* 禁用body滚动 */
      }

      button {
        background: none;
        border: none;
        cursor: pointer;
        color: inherit;
        -webkit-tap-highlight-color: transparent;
      }

      /* ================= 滚动容器 (Snap) ================= */
      .snap-container {
        height: 100dvh;
        width: 100vw;
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        scroll-behavior: smooth;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .snap-container::-webkit-scrollbar {
        display: none;
      }

      .snap-section {
        height: 100dvh;
        width: 100vw;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        background-color: var(--bg-color);
        overflow: hidden;
        position: relative;
        display: flex;
      }

      /* ================= 导航菜单 (核心修复部分) ================= */
      .nav-btn {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 100;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        backdrop-filter: blur(8px);
        color: white;
        transition: background 0.3s;
      }
      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .menu-overlay {
        position: fixed;
        inset: 0;
        z-index: 90;
        background: rgba(0, 0, 0, 0.98);
        backdrop-filter: blur(20px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s ease;
        /* 遮罩层本身不滚动，它包含滚动容器和固定按钮 */
      }
      .menu-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      /* 滚动容器：填满遮罩，负责滚动 */
      .menu-scroll-wrapper {
        position: absolute;
        inset: 0;
        overflow-y: auto; /* 允许垂直滚动 */
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        
        display: flex;        /* 关键：Flex布局 */
        flex-direction: column; 
        
        /* 底部留出足够空间，防止内容被底部的固定按钮遮挡 */
        padding-bottom: 120px; 
        
        /* 隐藏滚动条 */
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .menu-scroll-wrapper::-webkit-scrollbar {
        display: none;
      }

      /* 菜单内容容器 */
      .menu-content {
        /* 关键：margin: auto 在 Flex 容器中会自动实现完美的垂直+水平居中 
           同时保证当内容超出屏幕时，依然可以正常滚动 */
        margin: auto; 
        
        width: 100%;
        max-width: 600px;
        text-align: center;
        padding: 40px 20px; /* 顶部留白，防止贴顶 */
      }

      .menu-label {
        color: var(--text-sub);
        font-family: monospace;
        font-size: 12px;
        letter-spacing: 0.3em;
        margin-bottom: 40px;
      }

      .menu-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .menu-link {
        font-size: clamp(1.8rem, 6vw, 3rem);
        font-weight: 200;
        color: #71717a;
        transition: all 0.3s;
        display: inline-block;
        line-height: 1.2;
      }
      .menu-link:hover {
        color: white;
        transform: scale(1.05);
      }

      .menu-num {
        font-size: 12px;
        color: var(--accent);
        vertical-align: top;
        opacity: 0;
        transition: opacity 0.3s;
        margin-left: 4px;
      }
      .menu-link:hover .menu-num {
        opacity: 1;
      }

      /* 固定在底部的关闭按钮 */
      .close-btn-fixed {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
        color: var(--text-sub);
        transition: color 0.3s;
        padding: 10px;
      }
      .close-btn-fixed:hover {
        color: white;
      }

      /* ================= Intro Section ================= */
      .intro-section {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        background-color: #0a0a0a;
      }
      .intro-content h1 {
        font-size: clamp(3rem, 12vw, 6rem);
        font-weight: 100;
        letter-spacing: 0.1em;
        margin-bottom: 24px;
        line-height: 1;
      }
      .intro-content p {
        color: var(--text-sub);
        font-family: monospace;
        font-size: 14px;
        letter-spacing: 0.1em;
        opacity: 0.8;
      }
      .scroll-indicator {
        position: absolute;
        bottom: 40px;
        color: #3f3f46;
        animation: bounce 2s infinite;
      }
      @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
      }

      /* ================= 封面布局 (Cover Layout) ================= */
      .cover-layout {
        flex-direction: column;
      }

      /* 移动端/默认：图在上，文在下 */
      .cover-image-area {
        flex: 1;
        width: 100%;
        min-height: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 30px;
        background-color: var(--bg-color);
        position: relative;
      }
      
      .cover-image-area img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        display: block;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
      }

      .cover-info-area {
        flex: none;
        width: 100%;
        background: linear-gradient(to top, var(--bg-color), rgba(5,5,5,0.95), transparent);
        padding: 10px 24px 50px;
        z-index: 10;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
      }
      
      .cover-info-inner {
        max-width: 600px;
        margin: 0 auto;
        width: 100%;
        text-align: left;
      }

      .chapter-label {
        display: block;
        color: var(--accent);
        font-weight: bold;
        font-size: 12px;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        margin-bottom: 12px;
      }

      .chapter-title {
        font-size: 2.5rem;
        font-weight: 300;
        color: #fff;
        line-height: 1.1;
        margin-bottom: 16px;
      }

      .chapter-divider {
        width: 40px;
        height: 2px;
        background: rgba(255,255,255,0.2);
        margin-bottom: 16px;
      }

      .chapter-desc {
        color: #a1a1aa;
        font-size: 14px;
        line-height: 1.6;
        font-weight: 300;
      }

      /* 桌面端适配：左右布局 */
      @media (min-width: 768px) {
        .cover-layout {
          flex-direction: row;
        }
        .cover-image-area {
          padding: 60px;
        }
        .cover-info-area {
          width: 420px;
          height: 100%;
          background: var(--panel-bg);
          border-left: 1px solid rgba(255, 255, 255, 0.05);
          justify-content: center;
          padding: 60px;
        }
        .chapter-title {
          font-size: 3.5rem;
          margin-bottom: 24px;
        }
        .chapter-desc {
          font-size: 15px;
        }
      }

      /* ================= Photo Layout ================= */
      .photo-layout {
        flex-direction: column;
      }

      .image-area {
        flex: 1;
        min-height: 0;
        width: 100%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      .image-area img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
        display: block;
        box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.5);
      }

      .text-area {
        flex: none;
        width: 100%;
        background: linear-gradient(
          to top,
          var(--bg-color),
          rgba(5, 5, 5, 0.9),
          transparent
        );
        padding: 16px 24px 40px;
        z-index: 20;
      }

      .text-inner {
        max-width: 900px;
        margin: 0 auto;
      }
      .text-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 8px;
      }
      .album-name {
        font-size: 1rem;
        font-weight: 400;
        color: white;
      }
      .photo-meta {
        font-family: monospace;
        font-size: 12px;
        color: #52525b;
        display: none;
      }
      .photo-desc {
        font-size: 14px;
        color: var(--text-sub);
        font-weight: 300;
        line-height: 1.5;
      }

      @media (min-width: 768px) {
        .layout-portrait {
          flex-direction: row;
        }
        .layout-portrait .image-area {
          padding: 40px;
          background-color: var(--bg-color);
        }
        .layout-portrait .text-area {
          width: 380px;
          height: 100%;
          background: var(--panel-bg);
          border-left: 1px solid rgba(255, 255, 255, 0.05);
          display: flex;
          flex-direction: column;
          justify-content: center;
          padding: 48px;
        }
        .layout-landscape .text-area {
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          padding-bottom: 48px;
        }
        .photo-meta {
          display: block;
        }
        .album-name {
          color: var(--accent);
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: 0.15em;
        }
        .photo-desc {
          font-size: 15px;
          color: #d4d4d8;
        }
      }

      .footer-section {
        align-items: center;
        justify-content: center;
        background-color: #0a0a0a;
      }
      .footer-section p {
        font-family: monospace;
        font-size: 12px;
        letter-spacing: 0.2em;
        color: #3f3f46;
        text-transform: uppercase;
      }
    </style>
  </body>
</html>